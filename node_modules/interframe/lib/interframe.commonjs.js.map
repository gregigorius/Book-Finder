{"version":3,"file":"interframe.commonjs.js","sources":["../src/nextID.js","../src/index.js"],"sourcesContent":["let id = 0\n\nexport default function nextID()\n{\n  id += 1\n  return id\n}\n","/* eslint-disable filenames/match-exported, max-params, compat/compat */\n/* eslint-env browser */\n\nimport nextID from \"./nextID\"\n\nconst TYPE = \"application/interframe-ssoft-v1+json\"\nconst PROMISE_TIMEOUT = 3000\nconst HAS_CONSOLE_LOG =\n  typeof console !== \"undefined\" && typeof console.log === \"function\"\nconst UNIQUE_ID_RANDOM_LENGTH = 5\n\nfunction log(id, ...messages) {\n  if (HAS_CONSOLE_LOG) {\n    // eslint-disable-next-line no-console\n    console.log(`[interframe ${id}]`, ...messages)\n  }\n}\n\nfunction generateUniqueId() {\n  const nowDate = Date.now().toString()\n\n  return `${nowDate.substring(nowDate.length - UNIQUE_ID_RANDOM_LENGTH)}-${Math.random()\n    .toFixed(UNIQUE_ID_RANDOM_LENGTH)\n    .substring(2)}`\n}\n\nfunction interframe(\n  targetWindow,\n  origin = \"*\",\n  sourceWindow,\n  { debug } = { debug: false }\n) {\n  if (!targetWindow) {\n    throw new Error(\"parameter 'targetWindow' is missing\")\n  }\n\n  const ownId = generateUniqueId()\n\n  const listeners = new Map()\n  const handshakeCallback = new Set()\n  const responseResolver = new Map()\n  const preHandshakeSendQueue = new Set()\n  const outstandingMessages = new Map()\n  let isHandshaken = false\n\n  function addListener(namespace, callback) {\n    if (debug) {\n      log(ownId, `addListener() to ${namespace}`)\n    }\n    if (!listeners.has(namespace)) {\n      listeners.set(namespace, new Set())\n    }\n    listeners.get(namespace).add(callback)\n\n    if (outstandingMessages.has(namespace)) {\n      if (debug) {\n        log(\n          ownId,\n          ` \\\\- has ${outstandingMessages.get(namespace).length} outstanding messages`\n        )\n      }\n      outstandingMessages.get(namespace).forEach((message) => callback(message))\n      outstandingMessages.delete(namespace)\n    }\n\n    return callback\n  }\n\n  function removeListener(namespace, callback) {\n    if (debug) {\n      log(ownId, `removeListener() to ${namespace}`)\n    }\n    listeners.get(namespace).delete(callback)\n  }\n\n  function send(namespace, data = null, responseId) {\n    if (!namespace) {\n      throw new Error(\"parameter 'namespace' is missing\")\n    }\n    if (typeof namespace !== \"string\") {\n      throw new Error(\"parameter 'namespace' must be a string\")\n    }\n\n    if (!isHandshaken) {\n      if (debug) {\n        log(ownId, `send() to ${namespace} without handshake`, data)\n      }\n      return new Promise((resolve) => {\n        preHandshakeSendQueue.add({\n          namespace,\n          data,\n          responseId,\n          resolve\n        })\n      })\n    }\n\n    if (debug) {\n      log(ownId, `send() to ${namespace}`, data)\n    }\n    const id = nextID()\n\n    if (origin !== null) {\n      targetWindow.postMessage(\n        JSON.stringify({\n          id,\n          responseId,\n          type: TYPE,\n          namespace,\n          data\n        }),\n        origin\n      )\n    } else {\n      targetWindow.postMessage(\n        JSON.stringify({\n          id,\n          responseId,\n          type: TYPE,\n          namespace,\n          data\n        })\n      )\n    }\n\n    return new Promise((resolve) => {\n      const timer = setTimeout(() => {\n        responseResolver.delete(id)\n        resolve()\n      }, PROMISE_TIMEOUT)\n\n      responseResolver.set(id, {\n        resolve,\n        timer\n      })\n    })\n  }\n\n  function sendHandshake(acknowledgement = false) {\n    const message = {\n      type: TYPE,\n      handshakeConfirmation: Boolean(acknowledgement),\n      handshake: !acknowledgement\n    }\n\n    if (debug) {\n      if (acknowledgement) {\n        log(ownId, `sendHandshake() as acknowledgement to handshake request`)\n      } else {\n        log(ownId, `sendHandshake() as initial handshake request`)\n      }\n    }\n\n    if (origin !== null) {\n      targetWindow.postMessage(JSON.stringify(message), origin)\n    } else {\n      targetWindow.postMessage(JSON.stringify(message))\n    }\n  }\n\n  function isSafeMessage(msgSource, msgOrigin, msgType) {\n    const jsdom = window.navigator.userAgent.indexOf(\"jsdom\") >= 0 && msgSource === null\n    const safeSource = msgSource === targetWindow || jsdom\n    const safeOrigin = origin === \"*\" || origin === null || msgOrigin === origin\n    const safeType = msgType === TYPE\n\n    return safeSource && safeOrigin && safeType\n  }\n\n  function handleHandshake(data) {\n    if (data.handshake) sendHandshake(true)\n\n    isHandshaken = true\n\n    handshakeCallback.forEach((hsCallback) => hsCallback())\n    handshakeCallback.clear()\n\n    preHandshakeSendQueue.forEach((sendItem) =>\n      send(sendItem.namespace, sendItem.data, sendItem.responseId)\n        .then((response) => sendItem.resolve(response)) // eslint-disable-line promise/prefer-await-to-then\n        .catch(() => sendItem.resolve())\n    )\n    preHandshakeSendQueue.clear()\n  }\n\n  function objectAssignPolyfill(target) {\n    const result = Object(target)\n\n    for (let index = 1; index < arguments.length; index++) {\n      const nextSource = arguments[index] // eslint-disable-line prefer-rest-params\n\n      // Skip over if undefined or null\n      if (nextSource != null) {\n        for (const nextKey in nextSource) {\n          // Avoid bugs when hasOwnProperty is shadowed\n          // eslint-disable-next-line max-depth\n          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n            result[nextKey] = nextSource[nextKey]\n          }\n        }\n      }\n    }\n\n    return result\n  }\n  const objectAssign =\n    typeof Object.assign == \"function\" ? Object.assign : objectAssignPolyfill\n\n  function createMessage(messageData) {\n    const message = {\n      id: messageData.id,\n      data: messageData.data,\n      namespace: messageData.namespace,\n\n      open: () => {\n        message.isPromise = true\n\n        return objectAssign({}, messageData, {\n          response: (data) => {\n            send(messageData.namespace, data, messageData.id)\n          }\n        })\n      }\n    }\n\n    return message\n  }\n\n  function handleMessage(messageData) {\n    if (messageData.responseId && responseResolver.has(messageData.responseId)) {\n      if (debug) {\n        log(ownId, `handleMessage() having response id`, messageData)\n      }\n      const resolver = responseResolver.get(messageData.responseId)\n      clearTimeout(resolver.timer)\n      resolver.resolve(messageData)\n      responseResolver.delete(messageData.responseId)\n    } else {\n      const message = createMessage(messageData)\n\n      if (listeners.has(message.namespace)) {\n        if (debug) {\n          log(\n            ownId,\n            `handleMessage() received message having namespace listeners`,\n            messageData\n          )\n        }\n\n        listeners.get(message.namespace).forEach((listener) => {\n          // eslint-disable-next-line max-depth\n          if (typeof listener === \"function\") {\n            listener(createMessage(message))\n          } else if (listener) {\n            console.error(\"Listener is no function: \", listener) // eslint-disable-line\n          }\n        })\n      } else {\n        if (debug) {\n          log(\n            ownId,\n            `handleMessage() received message without listeners, put into outstanding messages queue`,\n            messageData\n          )\n        }\n        if (!outstandingMessages.has(message.namespace)) {\n          outstandingMessages.set(message.namespace, new Set())\n        }\n\n        outstandingMessages.get(message.namespace).add(createMessage(message))\n      }\n    }\n  }\n\n  function messageListener(event) {\n    let data\n    try {\n      data = JSON.parse(event.data)\n    } catch (error) {\n      return false\n    }\n\n    if (!isSafeMessage(event.source, event.origin, data.type)) {\n      return false\n    }\n\n    if (data.handshake || data.handshakeConfirmation) return handleHandshake(data)\n\n    return handleMessage(data)\n  }\n\n  const ownWindow = sourceWindow || window\n  ownWindow.addEventListener(\"message\", messageListener, false)\n\n  sendHandshake()\n\n  function hasHandshake(callback) {\n    if (isHandshaken) {\n      if (typeof callback === \"function\") {\n        callback()\n      }\n      return true\n    }\n\n    if (typeof callback === \"function\") {\n      handshakeCallback.add(callback)\n    }\n    return false\n  }\n\n  return {\n    addListener,\n    removeListener,\n    send,\n\n    hasHandshake\n  }\n}\n\nexport default interframe\n"],"names":["id","nextID","TYPE","PROMISE_TIMEOUT","HAS_CONSOLE_LOG","console","log","UNIQUE_ID_RANDOM_LENGTH","messages","generateUniqueId","nowDate","Date","now","toString","substring","length","Math","random","toFixed","interframe","targetWindow","origin","sourceWindow","debug","Error","ownId","listeners","Map","handshakeCallback","Set","responseResolver","preHandshakeSendQueue","outstandingMessages","isHandshaken","send","namespace","data","responseId","Promise","resolve","add","postMessage","JSON","stringify","type","timer","setTimeout","set","sendHandshake","acknowledgement","message","handshakeConfirmation","handshake","isSafeMessage","msgSource","msgOrigin","msgType","jsdom","window","navigator","userAgent","indexOf","safeOrigin","handleHandshake","forEach","hsCallback","clear","sendItem","then","response","objectAssign","Object","assign","objectAssignPolyfill","target","result","index","nextSource","arguments","nextKey","prototype","hasOwnProperty","call","createMessage","messageData","open","isPromise","handleMessage","has","resolver","get","clearTimeout","listener","error","ownWindow","addEventListener","messageListener","event","parse","source","hasHandshake","callback","addListener","removeListener"],"mappings":"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"}